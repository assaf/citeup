#!/usr/bin/env bash
set -eo pipefail

echo -e "\033[32m  Upgrading dependencies …\033[0m"
pnpm update

echo -e "\033[32m  Deduping dependencies …\033[0m"
pnpm dedupe --ignore-scripts
pnpm prune --ignore-scripts

echo -e "\033[32m  Security audit …\033[0m"
pnpm install
git add package.json pnpm-lock.yaml

echo -e "\033[32m  Running tests …\033[0m"
rm -rf __screenshots__/*.new.* __screenshots__/*.diff.png
pnpm test

echo -e "\033[32m  Auditing dependencies …\033[0m"
pnpm pnpm audit --prod || echo "Security audit failed"

echo -e "\033[32m  Commiting changes …\033[0m"
git --no-pager diff --unified=0 --color --word-diff HEAD~1 package.json
git commit -m "Upgrade dependencies" || echo

echo -e "\033[32m  Cleaning up …\033[0m"
git gc --aggressive --prune=now || echo

terminal-notifier -sound default  -title "$0" -message "Done!"
exit 0
